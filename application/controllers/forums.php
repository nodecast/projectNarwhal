<?php if ( ! defined('BASEPATH')) exit('No direct script access allowed');

class Forums extends CI_Controller {
	
	public function __construct()
	{
		parent::__construct();
		$this->utility->enforce_login();
		$this->load->model('forumsmodel');
		$this->load->library('textformat');
	}

	public function index()
	{
		$this->utility->page_title('Forums');
		
		$data = array();
		$data['forums'] = $this->forumsmodel->getForums();
		$data['userid'] = $this->utility->current_user('_id');
		$this->load->view('forums/list', $data);
	}
	
	public function view_forum($forum, $page = 1)
	{
		if($page < 1)
			$page = 1;
		$off = ($page - 1) * $this->config->item('threads_perpage');
	
		$forum = $this->forumsmodel->getForum($forum);
		if(!$forum)
			show_404();
		$this->forumsmodel->markForumAsRead($forum['_id'], $this->utility->current_user('_id'));
		$this->utility->page_title('Forums > '.$forum['name']);

		$data = array();
		$data['forum'] = $forum;
		$data['perpage'] = $this->config->item('threads_perpage');
		$data['posts_pp'] = $this->config->item('posts_perpage');
		$data['off'] = $off;
		$data['page'] = $page;
		$return = $this->forumsmodel->getThreads($forum['_id'], $data['perpage'], $off);
		$data['threads'] = $return['data'];
		$data['results'] = $return['count'];
		$data['userid'] = $this->utility->current_user('_id');
		$data['catchuptime'] = $this->utility->current_user('catchuptime');
		$this->load->view('forums/viewforum', $data);
	}
	
	public function view_thread($thread, $page = 1) {
		if($page < 1)
			$page = 1;
		$off = ($page - 1) * $this->config->item('posts_perpage');
		
		$thread = $this->forumsmodel->getThread($thread);
		if(!$thread)
			show_404();
		$this->forumsmodel->markForumAsRead($thread['forum'], $this->utility->current_user('_id'));
		
		$forum = $this->forumsmodel->getForum($thread['forum']);
		$posts = $this->forumsmodel->getPosts($thread['_id'], $this->config->item('posts_perpage'), $off);
		$this->utility->page_title('Forums > '.$forum['name'].' > '.$thread['name']);
		
		$this->load->library('form_validation');
		$this->load->helper('form');
		
		$data = array();
		$data['forum'] = $forum;
		$data['thread'] = $thread;
		$data['perpage'] = $this->config->item('posts_perpage');
		$data['page'] = $page;
		$data['posts'] = $posts['data'];
		$data['count'] = $posts['count'];
		$this->load->view('forums/viewthread', $data);
	}
	
	public function catchup() {
		$this->forumsmodel->catchup($this->utility->current_user('_id'));
		redirect('/forums/');
	}
	
	public function new_thread($forum) {
		$forum = $this->forumsmodel->getForum($forum);
		if(!$forum)
			show_404();
		$this->utility->page_title('New Thread');
		$this->load->library('form_validation');
		$this->load->helper('form');
		
		$this->form_validation->set_error_delimiters('<div class="error_message">', '</div>');
		$this->form_validation->set_rules('title', 'title', 'required|max_length[60]');
		$this->form_validation->set_rules('body', 'body', 'required|max_length['.$this->config->item('max_bytes_per_post').']');
		
		if(!$this->form_validation->run()) {
			$data = array();
			$data['forum'] = $forum;
			$data['preview'] = false;
			$this->load->view('forums/newthread', $data);
		} else {
			$thread = $this->forumsmodel->createThread($forum['_id'], $this->utility->current_user('_id'), $this->input->post('title'), $this->input->post('body'));
			redirect('/forums/view_thread/'.$thread);
		}
	}
	
	public function reply($thread) {
		$thread = $this->forumsmodel->getThread($thread);
		if(!$thread)
			show_404();
		$this->load->library('form_validation');
		$this->load->helper('form');
		
		$this->form_validation->set_rules('body', 'body', 'required|max_length['.$this->config->item('max_bytes_per_post').']');
		
		if(!$this->form_validation->run()) {
			redirect('/forums/view_thread/'.$thread['_id'].'#reply');
		} else {
			$post = $this->forumsmodel->replyToThread($thread['_id'], $this->utility->current_user('_id'), $this->input->post('body'));
			redirect('/forums/view_thread/'.$thread['_id'].'/'.$post['page'].'#post'.$post['_id']);
			//reply, then do #reply12831928389123 to go to it
			//redirect('/forums/view_thread/'.$thread['_id']);
		}
	}
	
	//supposed to be done over ajax
	public function edit_post($post) {
		$post = $this->forumsmodel->getPost($post);
		if(!$post || $post['owner'] != $this->utility->current_user('_id'))
			show_404();
			
		$body = $this->input->post('body');
		$this->forumsmodel->editPost($post['_id'], $body, $this->utility->current_user('_id'));
		
		echo $this->textformat->Parse($body);
		exit;
	}
}
